<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2022_kenshu_w3-4: SELogger: (Near-)Omniscient Logging Tool for Java</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">2022_kenshu_w3-4
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 構築: Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'検索','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','検索');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_Data_java8_selogger_README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">SELogger: (Near-)Omniscient Logging Tool for Java </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>SELogger is a Java Agent to record an execcution trace of a Java program. The tool name "SE" means Software Engineering, because the tool is developed for software engineering research topics including omniscient debugging.</p>
<p>The design of this tool is partly explained in the following articles.</p><ul>
<li>Kazumasa Shimari, Takashi Ishio, Tetsuya Kanda, Naoto Ishida, Katsuro Inoue: "NOD4J: Near-omniscient debugging tool for Java using size-limited execution trace", Science of Computer Programming, Volume 206, 2021, 102630, ISSN 0167-6423, <a href="https://doi.org/10.1016/j.scico.2021.102630">https://doi.org/10.1016/j.scico.2021.102630</a>.</li>
<li>Kazumasa Shimari, Takashi Ishio, Tetsuya Kanda, Katsuro Inoue: "Near-Omniscient Debugging for Java Using Size-Limited Execution Trace", ICSME 2019 Tool Demo Track, <a href="https://ieeexplore.ieee.org/abstract/document/8919216">https://ieeexplore.ieee.org/abstract/document/8919216</a></li>
</ul>
<p>The developement of this tool has been supported by JSPS KAKENHI Grant No. JP18H03221.</p>
<h1><a class="anchor" id="autotoc_md36"></a>
Usage</h1>
<p>Execute your Java program with SELogger using <code>-javaagent</code> option as follows. </p><pre class="fragment">    java -javaagent:/path/to/selogger-0.5.0.jar [Application Options]
</pre><p> SELogger accepts some options. Each option is specified by <code>option=value</code> style with commas (","). For example: </p><pre class="fragment">    java -javaagent:/path/to/selogger-0.5.0.jar=format=freq,weaverlog=log.txt [Application Options]
</pre><p> If you would like to record the behavior of test cases executed by Maven Surefire, you can use an <code>argLine</code> option. </p><pre class="fragment">    mvn -DargLine="-javaagent:/path/to/selogger-0.5.0.jar=format=freq,weaverlog=log.txt" test
</pre><p> Instead of a command line option, you can write the same option in your <code>pom.xml</code> file as follows. </p><pre class="fragment">    &lt;plugin&gt;
      &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
      &lt;configuration&gt;
       &lt;argLine&gt;-javaagent:/path/to/selogger-0.5.0.jar=format=freq,weaverlog=log.txt&lt;/argLine&gt;
       &lt;/configuration&gt;
       &lt;executions&gt;...&lt;/executions&gt;
     &lt;/plugin&gt;
</pre><p>SELogger produces a file named <code>trace.json</code> including the execution trace. The file format is described in the <a class="el" href="md_Data_java8_selogger_DataFormat.html">DataFormat.md</a> file. The DataFormat file also includes <a href="DataFormat.md#runtime-events">the list of recordable runtime events</a>.</p>
<h2><a class="anchor" id="autotoc_md37"></a>
Change a trace file name</h2>
<p>You can change a trace file name from the default <code>trace.json</code> using the <code>trace=</code> option. You can include <code>{time}</code> in the file name (e.g. <code>trace=trace-{time}.json</code>). <br  />
 The pattern <code>{time}</code> is replaced by the time of the program execution represented by the <code>yyyyMMdd-HHmmssSSS</code> format including year, month, day, hour, minute, second, and millisecond. You can also explicitly specify the format like this: <code>{time:yyyyMMdd}</code>. The format string is passed to <code>java.text.SimpleDateFormat</code> class.</p>
<p>It should be noted that SELogger overwrites existing trace files without warnings. Programs executed with the same option (e.g. parallel testing of Maven Surefire Plugin) may accidentally overwrite execution traces recorded by previous executions.</p>
<h2><a class="anchor" id="autotoc_md38"></a>
Check a weaving process log</h2>
<p>SELogger can produce a log including its internal process (e.g. the order of class loading). You can specify a log file name using the <code>weaverlog=</code> option. The file name also accepts the time pattern, e.g. <code>weaverlog=log-{time}.txt</code>.</p>
<h2><a class="anchor" id="autotoc_md39"></a>
Specify an output directory for more details</h2>
<p>The <code>output=</code> option specifies a directory to store the entire execution trace. <br  />
 The directory is automatically created if it does not exist.</p>
<p>The trace file and weaving log file are created in the directory if their file paths are not specified.</p>
<h2><a class="anchor" id="autotoc_md40"></a>
Select a Trace Format</h2>
<p>The <code>format=</code> option specifies a data format of an execution trace. The default is <code>nearomni</code> format. <br  />
</p>
<ul>
<li><code>freq</code> mode records only a frequency table of events.</li>
<li><code>nearomni</code> mode records the latest event data with timestamp and thread ID for each bytecode location. <code>latest</code> mode is an alias of <code>nearomni</code>.</li>
<li><code>omni</code> mode records all the events in a text stream. <code>omnibinary</code> mode records all the events in a binary stream.</li>
<li><code>discard</code> mode discard event data, while it injects logging code into classes.</li>
</ul>
<p>In the <code>nearomni</code> mode, three additional options are available:</p><ul>
<li><code>size=</code> specifies the size of buffers (the number of recorded events per source code location). The default is 32.<ul>
<li>The nearomni mode creates buffers for each event location. Each buffer consumes SIZE*20 bytes (e.g. 640 bytes in case of the default size). A large buffer size (or a large program) may cause OutOfMemoryError. When SELogger detected OutOfMemory, it records an error message and discards the execution trace to continue the program execution.</li>
</ul>
</li>
<li><code>keepobj={strong|weak|id}</code> specifies how to record objects in a trace.<ul>
<li>(Default) <code>keepobj=strong</code> keeps all objects in recent events.</li>
<li><code>keepobj=weak</code> keeps objects using weak references to avoid the impact to GC. It reduces memory consumption, while some object information may be lost.</li>
<li><code>keepobj=id</code> assigns unique IDs to objects in the same way as <code>format=omni</code>. This option maintains an object-to-id map on memory but may reduce memory consumption. For convenience, string and exception messages are also recorded in the trace file.</li>
<li>For compatibility with previous versions of SELogger, <code>keepobj={true|false}</code> is regarded as <code>keepobj={strong|weak}</code>, respectively.</li>
</ul>
</li>
<li><code>json={true|false}</code> specifies whether the output file is written in a JSON format or not.<ul>
<li>The default value is true. If this is set to false, a CSV format is used.</li>
</ul>
</li>
</ul>
<p>The <code>omni</code> mode records the contents of String objects and stack traces of exception objects when creating an object-to-id map.</p><ul>
<li>The <code>string=false</code> option discards the strings.</li>
<li>The <code>exception=message</code> option records only exception messages.</li>
<li>The <code>exception=none</code> option disables the recoding of stack traces.</li>
</ul>
<h2><a class="anchor" id="autotoc_md41"></a>
Select Event Types</h2>
<p>The default configuration records all events in <a href="DataFormat.md#runtime-events">the list of recordable runtime events</a>. If you are interested in only a subset of the events, you can exclude uninteresting events from logging. This option affects the runtime performance because SELogger does not inject logging code for the excluded events.</p>
<p>The <code>weave=</code> option specifies events to be recorded. Supported event groups are:</p>
<ul>
<li>EXEC (entry/exit)</li>
<li>CALL (call)</li>
<li>PARAM (parameters for method entries and calls)</li>
<li>FIELD (field access)</li>
<li>ARRAY (array creation and access)</li>
<li>OBJECT (constant object usage)</li>
<li>SYNC (synchronized blocks)</li>
<li>LOCAL (local variables)</li>
<li>LABEL (conditional branches)</li>
<li>LINE (line numbers)</li>
<li>ALL (All events listed above)</li>
</ul>
<p>The event group names EXEC and CALL come from AspectJ pointcut: execution and call.</p>
<p>You can add multiple groups in a single option using <code>+</code> (e.g., <code>weave=EXEC+CALL</code> method execution and call events). <br  />
</p>
<h2><a class="anchor" id="autotoc_md42"></a>
Exclude Libraries from Logging</h2>
<p>Logging may generate a huge amount of events. You can manually exclude some classes from logging by specifying filtering options.</p>
<p>Another reason to exclude some libraries is to avoid breaking library code. As SELogger inserts logging code into classes at runtime, the behavior may break some classes, e.g. those using a custom class loader. For example, SELogger excludes JavaFX classes from logging to avoid crash (<code>NoClassDefFoundError</code>).</p>
<p>You can find a list of loaded classes in the <code>log.txt</code> file generated by SELogger. <br  />
 A message <code>Weaving executed: [Class Name] loaded from [URI]</code> shows a pair of class name and location.</p>
<h3><a class="anchor" id="autotoc_md43"></a>
Filtering by Package and Class Names</h3>
<p>Using <code>e=</code> option, you can specify a prefix of class names excluded from the logging process. <br  />
 You can use multiple <code>e=</code> options to enumerate class paths. By default, the selogger excludes the system classes from logging: <code>sun/</code>,<code>com/sun/</code>, <code>java/</code>, <code>javax/</code>, and <code>javafx/</code>.</p>
<p>If a class is excluded from logging by this filter, a log message <code>Excluded by name filter: (the class name)</code> is recorded in a log file.</p>
<p>If you would like to add logging code to some filtered classes, you can use <code>i=</code> option. <br  />
 It also specifies a prefix of class names. A class having the prefix is included in logging even if it matches the <code>e=</code> option.</p>
<h3><a class="anchor" id="autotoc_md44"></a>
Filtering by File Location</h3>
<p>Using <code>exlocation=</code> option, you can exclude classes loaded from a particular directory or JAR file. If a specified string is included in a URI where the class is loaded, that class is excluded from logging. For example, you can exclude classes loaded from Maven dependencies by using <code>exlocation=.m2</code> option.</p>
<p>You can use multiple <code>exlocation=</code> options to enumerate file paths. By default, no location filter is configured.</p>
<p>If a class is excluded from logging by this filter, a log message <code>Excluded by class filter: (the class name) loaded from (location name)</code> is recorded in a log file.</p>
<h3><a class="anchor" id="autotoc_md45"></a>
Infinite loop risk</h3>
<p>The security manager mechanism of Java Virtual Machine may call a <code>checkPermission</code> method to check whether a method call is allowed in the current context or not. When a custom security manager having a <code>checkPermission</code> method is defined in a target program, SELogger injects logging code into the method by default. The logging code tries to record an execution of <code>checkPermission</code>. <br  />
 The logging step triggers an additional <code>checkPermission</code> call, and results in infinite recursive calls.</p>
<p>To reduce the risk of infinite recursive calls, SELogger automatically detects a subclass of SecurityManager and exclude the class from weaving. If such a class is detected, a log message <code>Excluded security manager subclass</code> is recorded. If you would like to weave logging code into such a subclass, add <code>weavesecuritymanager=true</code> option.</p>
<h2><a class="anchor" id="autotoc_md46"></a>
Record a Specified Interval</h2>
<p>SELogger supports four options to control the logging process: <code>logstart</code>, <code>logend</code>, <code>lognested</code>, and <code>logsave</code>. SELogger records all events from the beginning to the end of a program execution by default. A pair of <code>logstart=</code> and <code>logend=</code> options is available to specify an interval of interest (both <code>logstart=</code> and <code>logend=</code> must be specified to enable this filtering feature).</p>
<p>The logging is started when an event represented by <code>logstart</code> is observed. The logging is terminated after an event represented by <code>logend</code> is observed. The events between the <code>logstart</code> and <code>logend</code> events are included in an execution trace.</p><ul>
<li>If the <code>logstart</code> and <code>logend</code> point to the same event, only the event is recorded because the logging is enabled for the event but disabled again after the event.</li>
<li>The start and end of logging are triggered irrelevant to the thread of control. The logging started by a thread may be terminated by another thread.</li>
<li>The interval represented by <code>logstart</code> and <code>logend</code> events can be nested if an additional option <code>lognested=true</code> is specified. Otherwise, logging started by multiple <code>logstart</code> events can be terminated by a single <code>logend</code> event.</li>
</ul>
<p>The options accept a text pattern comprising four elements: <code>ClassName#MethodName#MethodDesc#EventType</code>.</p><ul>
<li>The <code>ClassName</code>, <code>MethodName</code>, and <code>MethodDesc</code> elements are regular expressions representing class names, method names, and method descriptors, respectively. <br  />
</li>
<li>The <code>EventType</code> element specifies a list of event types separated by <code>;</code>. <br  />
<ul>
<li>The event types are listed in <code><a class="el" href="enumselogger_1_1EventType.html">selogger.EventType</a></code> class. <br  />
</li>
<li><code>METHOD_EXIT</code> is a special keyword equivalent to <code>METHOD_NORMAL_EXIT;METHOD_EXCEPTIONAL_EXIT</code>.</li>
</ul>
</li>
<li>An empty pattern matches any text.</li>
</ul>
<p>The timings of logging start and end are recorded in <code>log.txt</code>. The logging on/off is switched by every occurrence of <code>logstart</code> and <code>logend</code> events. A <code>logstart</code> event after a <code>logend</code> event restarts the logging.</p>
<h3><a class="anchor" id="autotoc_md47"></a>
Example patterns</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Pattern   </th><th class="markdownTableHeadLeft">Interval    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>logstart=my/Class###METHOD_ENTRY</code>   </td><td class="markdownTableBodyLeft">Logging starts when any method entry events of <code>my/Class</code> class    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><code>logend=my/Class#testX##METHOD_EXIT</code>   </td><td class="markdownTableBodyLeft">Logging ends when <code>testX</code> method of <code>my/Class</code> is finished    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><code>logstart=#test.+#\(\)V#METHOD_ENTRY</code>   </td><td class="markdownTableBodyLeft">Logging starts at the beginning of any <code>test</code> method without parameters and return values. The parentheses are escaped because they are not a part of regular expression.   </td></tr>
</table>
<p>The following options records method entry, exit, and executed lines during executions of <code>testX</code> method defined in <code>my/Class</code> class. </p><div class="fragment"><div class="line">weave=EXEC+LINE,logstart=my/Class#testX##METHOD_ENTRY,logend=my/Class#testX##METHOD_EXIT</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md48"></a>
Saving an interval as a partial trace file</h3>
<p>You can save a partial trace file when the logging has been suspended by a <code>logend</code> event:</p>
<ul>
<li><code>logsave=snapshot</code> option saves a snapshot of the trace after the event. <br  />
</li>
<li><code>logsave=partial</code> option saves a partial trace and discards the recorded trace after the save. If the full trace included multiple intervals, each interval is saved as separated files.</li>
</ul>
<p>The options work when the format is <code>nearomni</code> and <code>freq</code>.</p>
<h2><a class="anchor" id="autotoc_md49"></a>
Option for Troubleshooting</h2>
<p>The <code>dump=true</code> option stores class files including logging code into the output directory. It may help a debugging task if invalid bytecode is generated.</p>
<h1><a class="anchor" id="autotoc_md50"></a>
Limitation</h1>
<p>The logging feature for some instructions (in particular, JUMP, RET, INVOKEDYNAMIC instructions) has not been tested well due to the lack of appropriate test cases.</p>
<p>To record Local variable names and line numbers, the tool uses debugging information embedded in class files.</p>
<h1><a class="anchor" id="autotoc_md51"></a>
Package Structure</h1>
<p>SELogger comprises three sub-packages: <code>logging</code>, <code>reader</code>, and <code>weaver</code>.</p>
<ul>
<li>The <code>weaver</code> sub-package is an implementation of Java Agent. <br  />
<ul>
<li>RuntimeWeaver class is the entry point of the agent. It calls ClassTransformer to inject logging instructions into target classes.</li>
</ul>
</li>
<li>The <code>logging</code> sub-package implements logging features.<ul>
<li>Logging class is the entry point of the logging feature. It records runtime events in files.</li>
</ul>
</li>
<li>The <code>reader</code> sub-package implements classes to read log files.<ul>
<li>LogPrinter class is an example to read <code>.slg</code> files generated by logging classes.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md52"></a>
How to Build from Source Code</h1>
<p>You can build a jar file with Maven. </p><pre class="fragment">    mvn package
</pre><p> The following command line uses the generated jar file to trace a test class in SELogger. </p><pre class="fragment">    java -javaagent:target/selogger-{version}.jar -classpath target/test-classes selogger.testdata.SimpleTarget
</pre><p> The resultant file <code>trace.json</code> includes an execution trace.</p>
<h2><a class="anchor" id="autotoc_md53"></a>
How to Build for JDK7</h2>
<p>selogger works with JDK 7 while selogger's test cases requires JDK 8 to test the behavior of INVOKEDYNAMIC instructions. If you would like to build a jar file for JDK7, please skip compilation of test classes as follows.</p><ul>
<li>Prepare JDK 7 and Maven.</li>
<li>Replace the JDK version <code>1.8</code> with <code>1.7</code> for the <code>maven-compiler-plugin</code> in <code>pom.xml</code>.</li>
<li>Execute <code>mvn package -Dmaven.test.skip=true</code>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md54"></a>
Dependencies</h2>
<p>SELogger uses:</p><ul>
<li>ASM (<a href="http://asm.ow2.org/">http://asm.ow2.org/</a>) to inject logging code.</li>
<li>Jackson-Core to write an execution trace in a JSON format.</li>
</ul>
<p>See <code>pom.xml</code> file for more details.</p>
<p>To avoid the conflict between the libraries for SELogger and for a target application, the package names in our binary file are renamed by maven-shade-plugin.</p>
<h1><a class="anchor" id="autotoc_md55"></a>
Static Weaving</h1>
<p>StaticWeaver is available to see the result of bytecode weaving. The feature can be executed as follows.</p>
<pre class="fragment">    java -classpath /path/to/selogger.jar selogger.weaver.StaticWeaver [weaving options] [target files]
</pre><p> The <code>[weaving options]</code> is the same as the argument for the runtime weaver. The target files may include class files, jar files, and directories including classes and jars. The resultant files are stored in <code>selogger-output</code>.</p>
<p>The current implementation does not allow to directly execute the woven program, because there is no way to load a Logger and close the logger at runtime.</p>
<h1><a class="anchor" id="autotoc_md56"></a>
History</h1>
<p>The first version of SELogger (in <code>icpc204</code> branch) is a static weaver for omniscient debugging . The execution trace recorded in this version is incompatible with the branch version. The major differences are:</p><ul>
<li>Simplified data format</li>
<li>Simplified instrumentation implementation</li>
<li>Simplified logging implementation (easy to extend)</li>
<li>Supported load-time weaving</li>
<li>Supported tracing jumps caused by exceptions</li>
<li>Supported fixed-size buffer logging</li>
<li>Improved reliability with JUnit test cases</li>
</ul>
<p>Please note that the documentation in the <code>doc</code> directory was written for the old version. We still keep the files for the record. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">構築: <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
